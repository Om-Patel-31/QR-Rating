<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login & QR Code</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>Register & Get Your Rating QR</h2>
    <form id="loginForm">
      <input type="text" id="firstName" placeholder="First Name" required />
      <input type="text" id="lastName" placeholder="Last Name" required />
      <input type="email" id="email" placeholder="Email (@ed.amdsb.ca)" required />
      <button type="submit">Generate QR</button>
    </form>

    <div id="qrContainer" class="hidden">
      <h3>Your QR Code</h3>
      <canvas id="qrCanvas"></canvas>
      <p>Show this QR code to others to get rated!</p>
    </div>
  </div>

  <script src="libs/qrcode.min.js"></script>
  <script>
    const loginForm = document.getElementById('loginForm');
    const qrContainer = document.getElementById('qrContainer');
    const qrCanvas = document.getElementById('qrCanvas');

    function saveUserData(user) {
      localStorage.setItem('loggedInUser', JSON.stringify(user));
      if (!localStorage.getItem('user_' + user.uid)) {
        localStorage.setItem('user_' + user.uid, JSON.stringify({
          firstName: user.firstName,
          lastName: user.lastName,
          email: user.email,
          ratings: []
        }));
      }
    }

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const firstName = e.target.firstName.value.trim();
      const lastName = e.target.lastName.value.trim();
      const email = e.target.email.value.trim().toLowerCase();

      if (!email.endsWith('@ed.amdsb.ca')) {
        alert('Email must end with @ed.amdsb.ca');
        return;
      }

      const uid = email.split('@')[0]; // unique user ID

      const user = { firstName, lastName, email, uid };

      saveUserData(user);

      const ratingURL = `${location.origin}/rating.html?uid=${uid}`;

      QRCode.toCanvas(qrCanvas, ratingURL, function (error) {
        if (error) {
          alert('Failed to generate QR code');
          console.error(error);
          return;
        }
        qrContainer.classList.remove('hidden');
      });
    });

    // If already logged in, auto-generate QR
    window.onload = () => {
      const storedUser = localStorage.getItem('loggedInUser');
      if (storedUser) {
        const user = JSON.parse(storedUser);
        const ratingURL = `${location.origin}/rating.html?uid=${user.uid}`;
        QRCode.toCanvas(qrCanvas, ratingURL, function (error) {
          if (!error) {
            qrContainer.classList.remove('hidden');
          }
        });
      }
    }
  </script>
</body>
</html>